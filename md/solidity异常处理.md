# Solidity 异常处理机制详解

## 1. 概述

Solidity 提供了多种异常处理方式，包括 `require`、`assert`、`revert` 以及 `try/catch`，用于保障合约安全、健壮和可维护性。

---

## 2. 关键字对比

| 关键字      | 主要用途         | 回滚交易 | Gas 消耗         | 错误信息支持 | 典型场景           |
|-------------|------------------|----------|------------------|--------------|--------------------|
| require     | 输入/条件验证     | 是       | 消耗已用gas      | 支持         | 参数、权限、余额   |
| assert      | 内部错误检查     | 是       | 消耗所有gas      | 不支持       | 不变量、溢出等     |
| revert      | 无条件回滚       | 是       | 消耗已用gas      | 支持         | 复杂分支、异常     |
| try/catch   | 捕获外部调用异常 | 是       | 消耗已用gas      | catch块可处理| 外部合约调用/创建  |

---

## 3. 详细说明与示例

### 3.1 require

- 用于**输入验证**和**条件检查**，如参数是否合法、余额是否足够、权限是否正确等。
- 条件不成立时，回滚交易，撤销所有状态更改，消耗已用gas，未用gas退还。
- 支持自定义错误信息。
- 语法简洁，适合简单条件判断。

**示例：**
```solidity
require(amount > 0, "金额必须大于0");
require(balance[msg.sender] >= amount, "余额不足");
```

---

### 3.2 assert

- 用于**内部错误检查**，确保合约自身逻辑和状态始终正确。
- 主要用于检测开发者的bug或不可能发生的情况（不变量）。
- 条件不成立时，回滚交易，消耗所有gas，不支持自定义错误信息。
- 适合检查数学运算溢出、状态变量关系等。

**示例：**
```solidity
uint c = a - b;
assert(c <= a); // 理论上永远成立，不成立说明代码有bug
```

---

### 3.3 revert

- 用于**无条件回滚**，可在代码任意位置直接终止并回滚交易。
- 适合复杂条件下的错误处理、嵌套分支、需要自定义错误类型的场景。
- 支持自定义错误信息。

**示例：**
```solidity
if (x < 10) {
    revert("x太小了");
}
if (x > 100) {
    revert("x太大了");
}
```

---

### 3.4 try/catch

- 用于捕获**外部合约调用**或**合约创建**时的异常（失败），让开发者可以优雅地处理错误，而不是让整个交易失败。
- 不能捕获本合约内部的 require、assert、revert 抛出的异常。

**语法与用法：**
```solidity
try 合约实例.方法名(参数) returns (返回值类型 变量) {
    // 调用成功时执行
} catch {
    // 调用失败时执行
}
```

**典型场景：**
- 调用外部合约时，对方合约可能不存在、已销毁或执行失败。
- 创建新合约时，可能因为 gas 不足等原因失败。

**示例：**
```solidity
try SomeContract(addr).someFunction() returns (uint256 result) {
    // 调用成功，result 可用
} catch {
    // 调用失败，可做降级处理或记录日志
}
```

---

## 4. 使用建议

- **require**：用于所有外部输入、参数、权限、余额等验证，是最常用的错误处理方式。
- **assert**：仅用于开发者自测，检查合约内部不变量或严重错误，正常业务逻辑下不应触发。
- **revert**：用于复杂分支、嵌套逻辑或需要自定义错误类型的场景。
- **try/catch**：用于捕获外部合约调用或合约创建的异常，不能捕获本地 require/assert/revert 抛出的异常。

---

## 5. 总结

- 以上关键字都会回滚交易，撤销所有状态更改。
- require 更适合输入验证，assert 用于内部一致性检查，revert 适合复杂或特殊回滚，try/catch 适合外部合约交互时的异常捕获。 